{"title":"相同文件压缩后 HASH 值（MD5）大概率不相同解决方案","date":"2021-08-01T07:20:41.000Z","link":"post/zip","tags":["javascript"],"updated":"2021-10-10T15:48:40.569Z","content":"<blockquote>\n<p>基本背景：工作中遇到的相同资源，压缩成 ZIP 包计算出的 MD5 不一致导致使用热更新时会出现问题。虽然也可以在压缩成 ZIP 包去计算 MD5 但是还是需要了解清楚始末以及对应的解决方案。</p>\n</blockquote>\n<h3 id=\"问题原因\"><strong>问题原因</strong><a href=\"post/zip#问题原因\"></a></h3><p>ZIP 压缩过程引入了跟时间相关的变量，改动了文件的 last access time。</p>\n<h3 id=\"为什么有时候又可以相同？\"><strong>为什么有时候又可以相同？</strong><a href=\"post/zip#为什么有时候又可以相同？\"></a></h3><p>ZIP 里存的 access time 只精确到秒（ZIP 文档里写着 access time 的格式是 The time values are in standard Unix signed-long format, indicating the number of seconds since 1 January 1970 00:00:00），如果两次 ZIP 的时间 YYYY-MM-DD HH-mm-SS 都一样，则两次 ZIP 文件内容结果相同。</p>\n<h3 id=\"解决方案\"><strong>解决方案</strong><a href=\"post/zip#解决方案\"></a></h3><ol>\n<li><p>使用 -X 或 –no-extra 参数，避免将附带了时间戳的 extra fields 打包进去。</p>\n <figure class=\"highlight bash\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> hahahaha &gt; xx</span><br><span class=\"line\">rm -f a.zip b.zip</span><br><span class=\"line\">zip -X a.zip xx</span><br><span class=\"line\">zip -X b.zip xx</span><br><span class=\"line\">md5 a.zip b.zip</span><br></pre></td></tr></table></div></figure>\n</li>\n<li><p>项目中使用的 <code>jszip</code> 库，可以在传递压缩参数时写死一个时间戳<br> <img src=\"https://user-images.githubusercontent.com/27424848/136687833-501f380c-65dc-43bc-ad35-e2f41b58681e.png\" alt=\"image\"></p>\n</li>\n</ol>\n<p>参考资料：</p>\n<p><a href=\"https://adoyle.me/blog/why-ZIP-file-checksum-changed.html\" target=\"_blank\" rel=\"noopener\">同一文件的两次 zip 内容不一致</a></p>\n<p><a href=\"https://www.codeboy.me/2019/03/20/zip-tricks/\" target=\"_blank\" rel=\"noopener\">Zip几点小知识</a></p>\n<p><a href=\"https://stackoverflow.com/questions/57175871/how-to-make-jsZIP-generate-same-buffer\" target=\"_blank\" rel=\"noopener\">How to make jszip generate same buffer</a></p>\n","prev":{"title":"《黑客与画家》书摘","link":"post/2021-8-21-book"},"next":{"title":"《被讨厌的勇气》书摘","link":"post/2021-07-02"},"plink":"https://yanoo1497.github.io/post/zip/"}