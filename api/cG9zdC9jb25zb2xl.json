{"title":"利用 prototype 重写 console 实现前端错误统计捕获","date":"2020-02-16T06:32:22.000Z","link":"post/console","tags":["javascript"],"categories":["javascript"],"updated":"2021-06-12T10:38:29.428Z","content":"<h2 id=\"背景\">背景<a href=\"post/console#背景\"></a></h2><p>由于业务上的需求，需要对已经写好的旧项目进行 log、warn、error、debug 等的数据进行统计，但是又不希望改动影响到旧代码。</p>\n<h2 id=\"思路\">思路<a href=\"post/console#思路\"></a></h2><p>主要是利用 js 的原型链，新写一个 console 继承自原始 console 然后对需要统计的方法那边进行重写捕获对应数据。</p>\n<h3 id=\"具体代码实现\">具体代码实现<a href=\"post/console#具体代码实现\"></a></h3><figure class=\"highlight ts\"><div><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; appendFileSync &#125; <span class=\"keyword\">from</span> <span class=\"string\">'fs'</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; outputFileSync &#125; <span class=\"keyword\">from</span> <span class=\"string\">'fs-extra'</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; join &#125; <span class=\"keyword\">from</span> <span class=\"string\">'path'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 自定义的一个新 console 类型，用于收集日志</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> NewConsole &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// --------------------- 重写 console 相关方法 -------------------------</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> log(...args: <span class=\"built_in\">any</span>[]) &#123;</span><br><span class=\"line\">        rawConsole.log(...args);</span><br><span class=\"line\">        <span class=\"comment\">// ... 统计处理</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> error(...args: <span class=\"built_in\">any</span>[]) &#123;</span><br><span class=\"line\">        rawConsole.error(...args);</span><br><span class=\"line\">        <span class=\"comment\">// ... 统计处理</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> warn(...args: <span class=\"built_in\">any</span>[]) &#123;</span><br><span class=\"line\">        rawConsole.warn(...args);</span><br><span class=\"line\">        <span class=\"comment\">// ... 统计处理</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> debug(...args: <span class=\"built_in\">any</span>[]) &#123;</span><br><span class=\"line\">        rawConsole.debug(...args);</span><br><span class=\"line\">        <span class=\"comment\">// ... 统计处理</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> rawConsole = <span class=\"built_in\">console</span>;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> newConsole = <span class=\"keyword\">new</span> NewConsole();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// @ts-ignore 手动继承 console</span></span><br><span class=\"line\">newConsole.__proto__.__proto__ = rawConsole;</span><br><span class=\"line\"><span class=\"comment\">// @ts-ignore 将处理过的继承自 console 的新对象赋给 windows</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.console = newConsole;</span><br></pre></td></tr></table></div></figure>\n\n<p>手动继承其实不是最好的方式，但是因为这个 console 的实现想要用正规的继承方式会比较麻烦困难以内采用了这种方式。</p>\n","prev":{"title":"JS 原型链速记总结","link":"post/prototype"},"next":{"title":"你可能不知道的 vscode 使用技巧","link":"post/你可能不知道的vscode使用技巧"},"plink":"https://yanoo1497.github.io/post/console/","toc":[{"title":"背景","id":"背景","index":"1"},{"title":"思路","id":"思路","index":"2","children":[{"title":"具体代码实现","id":"具体代码实现","index":"2.1"}]}]}